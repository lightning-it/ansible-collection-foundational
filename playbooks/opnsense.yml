---
- name: Provision OPNsense VM (production profile)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ansible_connection: local

    # Production VM profile defaults
    opnsense_vm_profile: prod
    opnsense_vm_cpu: 4
    opnsense_vm_ram_mb: 8192
    opnsense_vm_disk_gb: 60
    opnsense_vm_networks:
      - name: "{{ portgroup_wan | default('') }}"
        device_type: "vmxnet3"
      - name: "{{ portgroup_lan | default('') }}"
        device_type: "vmxnet3"
      - name: "{{ portgroup_mgmt | default('') }}"
        device_type: "vmxnet3"

  tasks:
    - name: Build network list for vmware_vsphere
      ansible.builtin.set_fact:
        _opnsense_vm_networks: >-
          {{
            opnsense_vm_networks
            | selectattr('name', 'defined')
            | rejectattr('name', 'equalto', '')
            | map('combine', {'connected': true})
            | list
          }}

    - name: Run vSphere provisioning
      ansible.builtin.include_role:
        name: lit.foundational.vmware_vsphere
      vars:
        vmware_vsphere_guest_id: freebsd64Guest
        vmware_vsphere_vmware_guest_hardware:
          num_cpus: "{{ opnsense_vm_cpu }}"
          memory_mb: "{{ opnsense_vm_ram_mb }}"
        vmware_vsphere_vmware_guest_disk:
          - size_gb: "{{ opnsense_vm_disk_gb }}"
            type: thin
        vmware_vsphere_vmware_guest_networks: "{{ _opnsense_vm_networks }}"

    - name: Ensure management IP is provided
      ansible.builtin.assert:
        that:
          - opnsense_mgmt_ip | default('') | length > 0
        fail_msg: "opnsense_mgmt_ip must be set (e.g., via DHCP reservation or discovery) to configure OPNsense."

    - name: Add OPNsense host to inventory
      ansible.builtin.add_host:
        name: "{{ opnsense_mgmt_ip }}"
        groups: opnsense
        ansible_host: "{{ opnsense_mgmt_ip }}"

- name: Configure OPNsense
  hosts: opnsense
  gather_facts: false

  roles:
    - role: lit.foundational.opnsense_config
