---
- name: Assert config xml is provided
  ansible.builtin.assert:
    that:
      - opnsense_config_xml | default('') | length > 0
    fail_msg: "Set opnsense_config_xml to the rendered config.xml content before running."

- name: Wait for SSH to become available
  ansible.builtin.wait_for:
    host: "{{ ansible_host | default(inventory_hostname) }}"
    port: "{{ opnsense_ssh_port }}"
    timeout: "{{ opnsense_ssh_wait_timeout }}"
    state: started
  delegate_to: localhost
  become: false

- name: Deploy config.xml
  ansible.builtin.template:
    src: "{{ opnsense_config_template }}"
    dest: /conf/config.xml
    owner: root
    group: wheel
    mode: "0600"
  register: opnsense_config_deployed
  notify: Reboot OPNsense
