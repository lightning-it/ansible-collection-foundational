---
# Resolve vSphere/vCenter credentials from multiple sources.
#
# Priority order:
# 1) vmware_vsphere_username / vmware_vsphere_password   (role-specific)
# 2) vcenter_username / vcenter_password                 (global preferred aliases)
# 3) vsphere_username / vsphere_password                 (legacy/global aliases)
# 4) Vault lookups (only if lookup strings are configured)
# 5) Environment variables (optional fallback)
#
# Result:
# - vmware_vsphere_username
# - vmware_vsphere_password

- name: Seed credentials from inventory/global aliases when role vars are unset/empty
  ansible.builtin.set_fact:
    vmware_vsphere_username: >-
      {{
        (vmware_vsphere_username | default('', true))
        or (vcenter_username | default('', true))
        or (vsphere_username | default('', true))
        or ''
      }}
    vmware_vsphere_password: >-
      {{
        (vmware_vsphere_password | default('', true))
        or (vcenter_password | default('', true))
        or (vsphere_password | default('', true))
        or ''
      }}
  no_log: true
  tags:
    - always

- name: Resolve vSphere username via Vault lookup (if configured)
  ansible.builtin.set_fact:
    vmware_vsphere_username: >-
      {{
        lookup(
          'community.hashi_vault.hashi_vault',
          vmware_vsphere_vmware_username_lookup,
          default=vmware_vsphere_username
        )
      }}
  when: (vmware_vsphere_vmware_username_lookup | default('', true) | length) > 0
  tags:
    - always

- name: Resolve vSphere password via Vault lookup (if configured)
  ansible.builtin.set_fact:
    vmware_vsphere_password: >-
      {{
        lookup(
          'community.hashi_vault.hashi_vault',
          vmware_vsphere_vmware_password_lookup,
          default=vmware_vsphere_password
        )
      }}
  when: (vmware_vsphere_vmware_password_lookup | default('', true) | length) > 0
  no_log: true
  tags:
    - always

# Optional environment fallback (CI/AAP-friendly)
- name: Fallback credentials from environment variables (optional)
  ansible.builtin.set_fact:
    vmware_vsphere_username: >-
      {{
        (vmware_vsphere_username | default('', true))
        or (lookup('env','VCENTER_USERNAME') | default('', true))
        or (lookup('env','VSPHERE_USERNAME') | default('', true))
        or ''
      }}
    vmware_vsphere_password: >-
      {{
        (vmware_vsphere_password | default('', true))
        or (lookup('env','VCENTER_PASSWORD') | default('', true))
        or (lookup('env','VSPHERE_PASSWORD') | default('', true))
        or ''
      }}
  when: >
    (vmware_vsphere_username | default('', true) | length == 0)
    or
    (vmware_vsphere_password | default('', true) | length == 0)
  no_log: true
  tags:
    - always
