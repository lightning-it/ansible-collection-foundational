---
# - name: 'Include tasks to ensure variables are defined properly'
#   ansible.builtin.include_tasks:
#     file: 'assert.yml'
#   tags: always

- name: Set fact to apply or destroy
  ansible.builtin.set_fact:
    terragrunt_action: >-
      {{ '-destroy' if terragrunt_destroy | bool else '' }}
    terragrunt_root_dir: >-
      {{ terragrunt_workdir | default(role_path ~ '/environments', true) }}
    terragrunt_env_dir: >-
      {{ (terragrunt_workdir | default(role_path ~ '/environments', true)) ~ '/' ~ inventory_hostname }}
  tags: always

- name: Ensure terragrunt root directory exists
  ansible.builtin.file:
    path: "{{ terragrunt_root_dir }}"
    state: directory
    mode: '0700'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Create terragrunt environment
  ansible.builtin.file:
    path: "{{ terragrunt_env_dir }}"
    state: directory
    recurse: true
    mode: '0700'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Create empty environments/root.hcl
  ansible.builtin.copy:
    content: ''
    dest: "{{ terragrunt_root_dir }}/root.hcl"
    mode: '0600'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Generate dynamic terragrunt for current cluster
  ansible.builtin.template:
    src: "{{ terragrunt_template }}"
    dest: "{{ terragrunt_env_dir }}/terragrunt.hcl"
    mode: '0600'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Preflight Vault token for terragrunt
  when:
    - terragrunt_vault_token_preflight | bool
    - terragrunt_vault_addr | default('', true) | trim | length > 0
    - terragrunt_vault_token | default('', true) | trim | length > 0
  tags:
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply
  block:
    - name: Lookup Vault token via lookup-self
      ansible.builtin.uri:
        url: "{{ terragrunt_vault_addr | trim }}/v1/auth/token/lookup-self"
        method: GET
        validate_certs: "{{ terragrunt_vault_validate_certs | bool }}"
        headers:
          X-Vault-Token: "{{ terragrunt_vault_token }}"
      register: terragrunt_vault_token_lookup
      failed_when: false
      changed_when: false
      delegate_to: "{{ terragrunt_delegate_to }}"
      become: false
      run_once: true
      no_log: true

    - name: Fail when Vault token is invalid for configured address
      ansible.builtin.fail:
        msg: >-
          VAULT_TOKEN lookup-self failed for {{ terragrunt_vault_addr }} (status
          {{ terragrunt_vault_token_lookup.status | default(0) }}).
          {{
            terragrunt_vault_token_lookup.msg
              | default('Ensure the token belongs to this Vault instance and TLS/DNS are correct.', true)
          }}
      when: terragrunt_vault_token_lookup.status | default(0) | int != 200

    - name: Record Vault token TTL and renewability
      ansible.builtin.set_fact:
        terragrunt_vault_token_ttl_seconds: >-
          {{
            terragrunt_vault_token_lookup.json.data.ttl
              | default(0)
              | int
          }}
        terragrunt_vault_token_renewable: >-
          {{
            terragrunt_vault_token_lookup.json.data.renewable
              | default(false)
              | bool
          }}
      changed_when: false
      run_once: true
      no_log: true

    - name: Renew Vault token when TTL is low and token is renewable
      ansible.builtin.uri:
        url: "{{ terragrunt_vault_addr | trim }}/v1/auth/token/renew-self"
        method: POST
        validate_certs: "{{ terragrunt_vault_validate_certs | bool }}"
        headers:
          X-Vault-Token: "{{ terragrunt_vault_token }}"
        body_format: json
        body:
          increment: "{{ terragrunt_vault_token_renew_increment }}"
      register: terragrunt_vault_token_renew
      failed_when: false
      changed_when: false
      delegate_to: "{{ terragrunt_delegate_to }}"
      become: false
      run_once: true
      no_log: true
      when:
        - terragrunt_vault_token_renew_if_low_ttl | bool
        - terragrunt_vault_token_renewable | bool
        - terragrunt_vault_token_ttl_seconds | int > 0
        - terragrunt_vault_token_ttl_seconds | int < (terragrunt_vault_token_min_ttl_seconds | int)

    - name: Re-check Vault token via lookup-self after renewal
      ansible.builtin.uri:
        url: "{{ terragrunt_vault_addr | trim }}/v1/auth/token/lookup-self"
        method: GET
        validate_certs: "{{ terragrunt_vault_validate_certs | bool }}"
        headers:
          X-Vault-Token: "{{ terragrunt_vault_token }}"
      register: terragrunt_vault_token_lookup_after_renew
      failed_when: false
      changed_when: false
      delegate_to: "{{ terragrunt_delegate_to }}"
      become: false
      run_once: true
      no_log: true
      when:
        - terragrunt_vault_token_renew is defined
        - terragrunt_vault_token_renew.status | default(0) | int in [200, 204]

    - name: Refresh Vault token TTL facts after renewal
      ansible.builtin.set_fact:
        terragrunt_vault_token_ttl_seconds: >-
          {{
            (
              terragrunt_vault_token_lookup_after_renew.json.data.ttl
                | default(terragrunt_vault_token_ttl_seconds | default(0))
            ) | int
          }}
        terragrunt_vault_token_renewable: >-
          {{
            terragrunt_vault_token_lookup_after_renew.json.data.renewable
              | default(terragrunt_vault_token_renewable | default(false))
              | bool
          }}
      changed_when: false
      run_once: true
      no_log: true
      when: terragrunt_vault_token_lookup_after_renew is defined

    - name: Fail when Vault token TTL is too low for terragrunt apply
      ansible.builtin.fail:
        msg: >-
          VAULT_TOKEN TTL is {{ terragrunt_vault_token_ttl_seconds }}s, below required
          {{ terragrunt_vault_token_min_ttl_seconds }}s for terragrunt apply.
          Provide a longer-lived/admin token for bootstrap, or increase token TTL.
      when:
        - terragrunt_vault_token_fail_on_low_ttl | bool
        - terragrunt_vault_token_ttl_seconds | int > 0
        - terragrunt_vault_token_ttl_seconds | int < (terragrunt_vault_token_min_ttl_seconds | int)

- name: Terragrunt init
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: terragrunt init --source-update
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_init
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Validate terragrunt import definitions
  ansible.builtin.assert:
    that:
      - item.address is defined
      - item.address | trim | length > 0
      - item.id is defined
      - (item.id | string) | trim | length > 0
    quiet: true
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    label: "{{ item.address | default('') }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  run_once: true
  become: false
  when: terragrunt_imports | default([], true) | length > 0
  tags: terragrunt_plan

- name: Terragrunt state show (pre-import check)
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command:
    argv:
      - terragrunt
      - state
      - show
      - "{{ item.address }}"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_state_show
  failed_when: false
  changed_when: false
  run_once: true
  become: false
  when: terragrunt_imports | default([], true) | length > 0
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    label: "{{ item.address }}"
  tags: terragrunt_plan

- name: Terragrunt import resources missing from state
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command:
    argv:
      - terragrunt
      - import
      - -input=false
      - "{{ item.address }}"
      - "{{ item.id }}"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_import
  failed_when: terragrunt_import_strict | bool and terragrunt_import.rc != 0
  changed_when: false
  run_once: true
  become: false
  when:
    - terragrunt_imports | default([], true) | length > 0
    - terragrunt_state_show is defined
    - terragrunt_state_show.results[terragrunt_import_index].rc | default(1) != 0
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    index_var: terragrunt_import_index
    label: "{{ item.address }}"
  tags: terragrunt_plan

- name: Terragrunt validate
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: "terragrunt validate"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_validate
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Terragrunt fmt
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt run -- fmt -list=true -write=false -diff=true
    -check=true -recursive
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_fmt
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Terragrunt plan
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt plan {{ terragrunt_action }}
    -no-color
    {{ '-detailed-exitcode' if (terragrunt_use_detailed_exitcode | bool) else '' }}
    -out={{ terragrunt_plan_file | default('/tmp/tf_plan', true) }}
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_plan
  failed_when: >-
    (
      (terragrunt_use_detailed_exitcode | bool)
      and (terragrunt_plan.rc | default(1) not in [0, 2])
    )
    or
    (
      not (terragrunt_use_detailed_exitcode | bool)
      and (terragrunt_plan.rc | default(1) != 0)
    )
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_plan

- name: Determine terragrunt plan change status
  ansible.builtin.set_fact:
    terragrunt_plan_has_changes: "{{ (terragrunt_plan.rc | default(0) | int) == 2 }}"
  changed_when: false
  run_once: true
  become: false
  when: terragrunt_use_detailed_exitcode | bool
  tags:
    - terragrunt_plan
    - terragrunt_apply

- name: Show plan
  ansible.builtin.debug:
    msg: "{{ terragrunt_plan.stdout_lines }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  run_once: true
  become: false
  tags: terragrunt_plan

- name: Ask for confirmation
  ansible.builtin.pause:
    prompt: "Are you sure you want to apply the changes? (yes/no)"
  register: confirm_apply
  become: false
  when:
    - (terragrunt_plan_has_changes | default(true) | bool)
    - not terragrunt_skip_confirmation
  tags: terragrunt_apply

- name: Terragrunt apply
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt apply -input=false -auto-approve
    {{ terragrunt_action }} {{ terragrunt_plan_file | default('/tmp/tf_plan', true) }}
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_apply
  changed_when: false
  when:
    - (terragrunt_plan_has_changes | default(true) | bool)
    - terragrunt_skip_confirmation | bool
      or (confirm_apply.user_input is defined and (confirm_apply.user_input | bool))
  run_once: true
  become: false
  tags: terragrunt_apply

- name: Cleanup terragrunt environment
  ansible.builtin.file:
    path: "{{ terragrunt_env_dir }}"
    state: absent
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate
