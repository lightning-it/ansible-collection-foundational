---
# - name: 'Include tasks to ensure variables are defined properly'
#   ansible.builtin.include_tasks:
#     file: 'assert.yml'
#   tags: always

- name: Set fact to apply or destroy
  ansible.builtin.set_fact:
    terragrunt_action: >-
      {{ '-destroy' if terragrunt_destroy | bool else '' }}
    terragrunt_root_dir: >-
      {{ terragrunt_workdir | default(role_path ~ '/environments', true) }}
    terragrunt_env_dir: >-
      {{ (terragrunt_workdir | default(role_path ~ '/environments', true)) ~ '/' ~ inventory_hostname }}
  tags: always

- name: Ensure terragrunt root directory exists
  ansible.builtin.file:
    path: "{{ terragrunt_root_dir }}"
    state: directory
    mode: '0700'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Create terragrunt environment
  ansible.builtin.file:
    path: "{{ terragrunt_env_dir }}"
    state: directory
    recurse: true
    mode: '0700'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Create empty environments/root.hcl
  ansible.builtin.copy:
    content: ''
    dest: "{{ terragrunt_root_dir }}/root.hcl"
    mode: '0600'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Generate dynamic terragrunt for current cluster
  ansible.builtin.template:
    src: "{{ terragrunt_template }}"
    dest: "{{ terragrunt_env_dir }}/terragrunt.hcl"
    mode: '0600'
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate

- name: Terragrunt init
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: terragrunt init --source-update
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_init
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Validate terragrunt import definitions
  ansible.builtin.assert:
    that:
      - item.address is defined
      - item.address | trim | length > 0
      - item.id is defined
      - (item.id | string) | trim | length > 0
    quiet: true
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    label: "{{ item.address | default('') }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  run_once: true
  become: false
  when: terragrunt_imports | default([], true) | length > 0
  tags: terragrunt_plan

- name: Terragrunt state show (pre-import check)
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command:
    argv:
      - terragrunt
      - state
      - show
      - "{{ item.address }}"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_state_show
  failed_when: false
  changed_when: false
  run_once: true
  become: false
  when: terragrunt_imports | default([], true) | length > 0
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    label: "{{ item.address }}"
  tags: terragrunt_plan

- name: Terragrunt import resources missing from state
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command:
    argv:
      - terragrunt
      - import
      - -input=false
      - "{{ item.address }}"
      - "{{ item.id }}"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_import
  failed_when: terragrunt_import_strict | bool and terragrunt_import.rc != 0
  changed_when: false
  run_once: true
  become: false
  when:
    - terragrunt_imports | default([], true) | length > 0
    - terragrunt_state_show is defined
    - terragrunt_state_show.results[terragrunt_import_index].rc | default(1) != 0
  loop: "{{ terragrunt_imports | default([], true) }}"
  loop_control:
    index_var: terragrunt_import_index
    label: "{{ item.address }}"
  tags: terragrunt_plan

- name: Terragrunt validate
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: "terragrunt validate"
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_validate
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Terragrunt fmt
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt run -- fmt -list=true -write=false -diff=true
    -check=true -recursive
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_fmt
  changed_when: false
  run_once: true
  become: false
  tags: terragrunt_validate

- name: Terragrunt plan
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt plan {{ terragrunt_action }}
    -no-color -out={{ terragrunt_plan_file | default('/tmp/tf_plan', true) }}
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_plan
  vars:
    terragrunt_no_change_pattern: >-
      No objects need to be destroyed|infrastructure matches the configuration
  changed_when: not terragrunt_plan.stdout | regex_search(terragrunt_no_change_pattern)
  run_once: true
  become: false
  tags: terragrunt_plan

- name: Show plan
  ansible.builtin.debug:
    msg: "{{ terragrunt_plan.stdout_lines }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  run_once: true
  become: false
  tags: terragrunt_plan

- name: Ask for confirmation
  ansible.builtin.pause:
    prompt: "Are you sure you want to apply the changes? (yes/no)"
  register: confirm_apply
  become: false
  vars:
    terragrunt_no_change_pattern: >-
      No objects need to be destroyed|infrastructure matches the configuration
  when:
    - terragrunt_plan.stdout is defined
    - not terragrunt_plan.stdout | regex_search(terragrunt_no_change_pattern)
    - not terragrunt_skip_confirmation
  tags: terragrunt_apply

- name: Terragrunt apply
  environment:
    TF_HTTP_USERNAME: "{{ terragrunt_http_username }}"
    TF_HTTP_PASSWORD: "{{ terragrunt_http_password }}"
    VAULT_TOKEN: "{{ terragrunt_vault_token | default(omit, true) }}"
    VAULT_ADDR: "{{ terragrunt_vault_addr | default(omit, true) }}"
  ansible.builtin.command: >-
    terragrunt apply -input=false -auto-approve
    {{ terragrunt_action }} {{ terragrunt_plan_file | default('/tmp/tf_plan', true) }}
  args:
    chdir: "{{ terragrunt_env_dir }}"
  delegate_to: "{{ terragrunt_delegate_to }}"
  register: terragrunt_apply
  changed_when: false
  when:
    - terragrunt_skip_confirmation | bool
      or (confirm_apply.user_input is defined and (confirm_apply.user_input | bool))
  run_once: true
  become: false
  tags: terragrunt_apply

- name: Cleanup terragrunt environment
  ansible.builtin.file:
    path: "{{ terragrunt_env_dir }}"
    state: absent
  delegate_to: "{{ terragrunt_delegate_to }}"
  become: false
  changed_when: false
  tags: terragrunt_validate
