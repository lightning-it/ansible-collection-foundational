---
# ---------------------------------------------------------------------------
# Build network_connections + net_lan_ifaces from:
# - net_wan_iface, net_admin_iface, net_trunk_parent
# - net_admin_ip_cidr, net_admin_gateway4, net_admin_dns
# - net_vlan_configs: [{id, ip_cidr}, ...]
#
# Output facts:
# - network_connections (unless already defined or overwrite enabled)
# - net_lan_ifaces
# ---------------------------------------------------------------------------

- name: Skip when autogen is disabled
  ansible.builtin.meta: end_play
  when: not (net_autogen_enabled | bool)
  tags: [always]

# Only run if there is something to generate
- name: Validate inputs (only if net_vlan_configs is provided)
  ansible.builtin.assert:
    that:
      - net_wan_iface | default('') | length > 0
      - net_admin_iface | default('') | length > 0
      - net_trunk_parent | default('') | length > 0
      - net_admin_ip_cidr | default('') | length > 0
      - net_admin_gateway4 | default('') | length > 0
      - net_vlan_configs is sequence
      - net_vlan_configs | length > 0
    fail_msg: >-
      Missing required inputs for net_vlan_autogen on {{ inventory_hostname }}.

      Required:
      - net_wan_iface
      - net_admin_iface
      - net_trunk_parent
      - net_admin_ip_cidr
      - net_admin_gateway4
      - net_vlan_configs (list of objects with id + ip_cidr)
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
  tags: [always]

- name: Initialize VLAN network_connections list
  ansible.builtin.set_fact:
    _net_vlan_network_connections: []
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Append VLAN subinterfaces
  ansible.builtin.set_fact:
    _net_vlan_network_connections: >-
      {{
        _net_vlan_network_connections + [
          {
            'name': 'vlan' ~ (item.id | string),
            'type': 'vlan',
            'interface_name': net_trunk_parent ~ '.' ~ (item.id | string),
            'parent': net_trunk_connection_name,
            'vlan_id': (item.id | int),
            'autoconnect': true,
            'ip': { 'address': [ item.ip_cidr ] }
          }
        ]
      }}
  loop: "{{ net_vlan_configs }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Build net_lan_ifaces + generated network_connections
  ansible.builtin.set_fact:
    _net_autogen_lan_ifaces: >-
      {{
        net_vlan_configs
        | map(attribute='id')
        | map('int')
        | map('string')
        | map('regex_replace', '^(.*)$', net_trunk_parent ~ '.\\1')
        | list
      }}
    _net_autogen_network_connections: >-
      {{
        [
          {
            'name': net_wan_connection_name,
            'type': 'ethernet',
            'interface_name': net_wan_iface,
            'autoconnect': true,
            'ip': { 'dhcp4': (net_wan_dhcp4 | default(true) | bool) }
          },
          {
            'name': net_admin_connection_name,
            'type': 'ethernet',
            'interface_name': net_admin_iface,
            'autoconnect': true,
            'ip': {
              'address': [ net_admin_ip_cidr ],
              'gateway4': net_admin_gateway4,
              'dns': (net_admin_dns | default([]))
            }
          },
          {
            'name': net_trunk_connection_name,
            'type': 'ethernet',
            'interface_name': net_trunk_parent,
            'autoconnect': true,
            'ip': { 'dhcp4': false }
          }
        ] + (_net_vlan_network_connections | default([]))
      }}
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Publish generated facts (unless network_connections already set)
  ansible.builtin.set_fact:
    net_lan_ifaces: "{{ _net_autogen_lan_ifaces }}"
    network_connections: "{{ _net_autogen_network_connections }}"
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
    - (net_autogen_overwrite | bool) or (network_connections is not defined)
  tags: [always]

- name: Debug summary (optional)
  ansible.builtin.debug:
    msg:
      - "net_lan_ifaces: {{ net_lan_ifaces | default([]) }}"
      - "network_connections count: {{ (network_connections | default([])) | length }}"
  when:
    - net_vlan_configs is defined
    - net_vlan_configs | length > 0
  tags: [never, debug]
