---
# ---------------------------------------------------------------------------
# Build network_connections + net_lan_ifaces from:
# - net_wan_iface, net_admin_iface, net_trunk_parent
# - net_admin_ip_cidr, net_admin_gateway4, net_admin_dns
# - net_vlan_configs: [{id, ip_cidr}, ...]
#
# Output facts:
# - network_connections (unless already defined or overwrite enabled)
# - net_lan_ifaces
# ---------------------------------------------------------------------------

- name: Normalize role variables
  ansible.builtin.set_fact:
    _net_autogen_enabled: "{{ net_vlan_autogen_enabled | default(net_autogen_enabled, true) | default(true) | bool }}"
    _net_autogen_overwrite: >-
      {{
        net_vlan_autogen_overwrite
          | default(net_autogen_overwrite, true)
          | default(false)
          | bool
      }}
    _net_autogen_wan_connection_name: >-
      {{
        net_vlan_autogen_wan_connection_name
          | default(net_wan_connection_name, true)
          | default('wan')
      }}
    _net_autogen_wan_ip_cidr: >-
      {{
        net_vlan_autogen_wan_ip_cidr
          | default(net_wan_ip_cidr, true)
          | default('', true)
      }}
    _net_autogen_wan_gateway4: >-
      {{
        net_vlan_autogen_wan_gateway4
          | default(net_wan_gateway4, true)
          | default('', true)
      }}
    _net_autogen_wan_dns: >-
      {{
        net_vlan_autogen_wan_dns
          | default(net_wan_dns, true)
          | default([], true)
      }}
    _net_autogen_admin_connection_name: >-
      {{
        net_vlan_autogen_admin_connection_name
          | default(net_admin_connection_name, true)
          | default('admin')
      }}
    _net_autogen_trunk_connection_name: >-
      {{
        net_vlan_autogen_trunk_connection_name
          | default(net_trunk_connection_name, true)
          | default('trunk-parent')
      }}
    _net_autogen_wan_dhcp4: >-
      {{
        (
          net_wan_dhcp4
            if (net_wan_dhcp4 is defined)
            else net_vlan_autogen_wan_dhcp4
        )
        | default(true)
        | bool
      }}
    _net_autogen_admin_dns: "{{ net_vlan_autogen_admin_dns | default(net_admin_dns, true) | default([], true) }}"
    _net_autogen_vlan_configs: >-
      {{
        net_vlan_autogen_vlan_configs
          | default(net_vlan_configs, true)
          | default([], true)
      }}
  changed_when: false
  tags: [always]

- name: Skip when autogen is disabled
  ansible.builtin.meta: end_play
  when: not _net_autogen_enabled
  tags: [always]

# Only run if there is something to generate
- name: Validate inputs (only if VLAN configs are provided)
  ansible.builtin.assert:
    that:
      - net_wan_iface | default('') | length > 0
      - net_admin_iface | default('') | length > 0
      - net_trunk_parent | default('') | length > 0
      - net_admin_ip_cidr | default('') | length > 0
      - net_admin_gateway4 | default('') | length > 0
      - _net_autogen_vlan_configs is sequence
      - _net_autogen_vlan_configs | length > 0
      - (_net_autogen_wan_dhcp4) or (_net_autogen_wan_ip_cidr | default('') | length > 0)
    fail_msg: >-
      Missing required inputs for net_vlan_autogen on {{ inventory_hostname }}.

      Required:
      - net_wan_iface
      - net_admin_iface
      - net_trunk_parent
      - net_admin_ip_cidr
      - net_admin_gateway4
      - net_vlan_configs (list of objects with id + ip_cidr)
      - net_wan_ip_cidr (when DHCP is disabled)
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
  tags: [always]

- name: Initialize VLAN network_connections list
  ansible.builtin.set_fact:
    _net_vlan_network_connections: []
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Append VLAN subinterfaces
  ansible.builtin.set_fact:
    _net_vlan_network_connections: >-
      {{
        _net_vlan_network_connections + [
          {
            'name': 'vlan' ~ (item.id | string),
            'type': 'vlan',
            'interface_name': net_trunk_parent ~ '.' ~ (item.id | string),
            'parent': _net_autogen_trunk_connection_name,
            'vlan_id': (item.id | int),
            'autoconnect': true,
            'state': 'up',
            'ip': { 'address': [ item.ip_cidr ] }
          }
        ]
      }}
  loop: "{{ _net_autogen_vlan_configs }}"
  loop_control:
    label: "{{ item.id }}"
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Build WAN IP dict
  ansible.builtin.set_fact:
    _net_autogen_wan_ip: >-
      {{
        ({ 'dhcp4': true })
          if _net_autogen_wan_dhcp4
          else (
            { 'address': [ _net_autogen_wan_ip_cidr ] }
            | combine(
                (_net_autogen_wan_gateway4 | length > 0)
                  | ternary({ 'gateway4': _net_autogen_wan_gateway4 }, {})
              )
            | combine(
                (_net_autogen_wan_dns | length > 0)
                  | ternary({ 'dns': _net_autogen_wan_dns }, {})
              )
          )
      }}
  changed_when: false
  tags: [always]

- name: Build net_lan_ifaces + generated network_connections
  ansible.builtin.set_fact:
    _net_autogen_lan_ifaces: >-
      {{
        _net_autogen_vlan_configs
        | map(attribute='id')
        | map('int')
        | map('string')
        | map('regex_replace', '^', net_trunk_parent ~ '.')
        | list
      }}
    _net_autogen_network_connections: >-
      {{
        [
          {
            'name': _net_autogen_wan_connection_name,
            'type': 'ethernet',
            'interface_name': net_wan_iface,
            'autoconnect': true,
            'state': 'up',
            'ip': _net_autogen_wan_ip
          },
          {
            'name': _net_autogen_admin_connection_name,
            'type': 'ethernet',
            'interface_name': net_admin_iface,
            'autoconnect': true,
            'state': 'up',
            'ip': {
              'address': [ net_admin_ip_cidr ],
              'gateway4': net_admin_gateway4,
              'dns': _net_autogen_admin_dns
            }
          },
          {
            'name': _net_autogen_trunk_connection_name,
            'type': 'ethernet',
            'interface_name': net_trunk_parent,
            'autoconnect': true,
            'state': 'up',
            'ip': { 'dhcp4': false }
          }
        ] + (_net_vlan_network_connections | default([]))
      }}
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
  changed_when: false
  tags: [always]

- name: Publish generated facts (unless network_connections already set)
  ansible.builtin.set_fact:
    net_lan_ifaces: "{{ _net_autogen_lan_ifaces }}"
    network_connections: "{{ _net_autogen_network_connections }}"
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
    - _net_autogen_overwrite or (network_connections is not defined)
  tags: [always]

- name: Debug summary (optional)
  ansible.builtin.debug:
    msg:
      - "net_lan_ifaces: {{ net_lan_ifaces | default([]) }}"
      - "network_connections count: {{ (network_connections | default([])) | length }}"
  when:
    - _net_autogen_vlan_configs is defined
    - _net_autogen_vlan_configs | length > 0
  tags: [never, debug]
