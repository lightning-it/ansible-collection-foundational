---
- name: Assert required inputs
  ansible.builtin.assert:
    that:
      - oob_baseuri | length > 0
      - oob_user | length > 0
      - oob_password | length > 0
    fail_msg: "oob_baseuri/oob_user/oob_password mÃ¼ssen gesetzt sein."

- name: Normalize baseuri input
  ansible.builtin.set_fact:
    _oob_baseuri_input: "{{ vars.get('oob_baseuri', inventory_hostname) | string }}"
  changed_when: false

- name: Normalize baseuri (strip scheme/path)
  ansible.builtin.set_fact:
    _oob_baseuri_effective: >-
      {{
        (
          (
            ((_oob_baseuri_input | regex_search('\\{\\{')) is not none)
            | ternary(inventory_hostname, _oob_baseuri_input)
          )
          | trim
          | regex_replace('^(https?://)+', '')
          | regex_replace('/redfish/v1/?$', '')
          | regex_replace('/+$', '')
        )
      }}
  changed_when: false

- name: Normalize Redfish auth inputs
  ansible.builtin.set_fact:
    _oob_user_input: "{{ vars.get('oob_user', '') | string }}"
    _oob_password_input: "{{ vars.get('oob_password', '') | string }}"
  changed_when: false

- name: Guard against recursive Redfish auth templates
  ansible.builtin.set_fact:
    oob_user: "{{ ((_oob_user_input | regex_search('\\{\\{')) is not none) | ternary('', _oob_user_input) }}"
    oob_password: "{{ ((_oob_password_input | regex_search('\\{\\{')) is not none) | ternary('', _oob_password_input) }}"
  changed_when: false

- name: Normalize Redfish connection inputs
  ansible.builtin.set_fact:
    _oob_validate_certs_input: "{{ vars.get('oob_validate_certs', false) }}"
    _oob_no_log_input: "{{ vars.get('oob_no_log', true) }}"
    _oob_timeout_input: "{{ vars.get('oob_timeout', 60) }}"
    _oob_ca_path_input: "{{ vars.get('oob_ca_path', '') | string }}"
  changed_when: false

- name: Guard against recursive Redfish connection templates
  ansible.builtin.set_fact:
    oob_validate_certs: >-
      {{
        ((_oob_validate_certs_input | string | regex_search('\\{\\{')) is not none)
        | ternary(false, (_oob_validate_certs_input | bool))
      }}
    oob_no_log: >-
      {{
        ((_oob_no_log_input | string | regex_search('\\{\\{')) is not none)
        | ternary(true, (_oob_no_log_input | bool))
      }}
    oob_timeout: >-
      {{
        ((_oob_timeout_input | string | regex_search('\\{\\{')) is not none)
        | ternary(60, (_oob_timeout_input | int))
      }}
    oob_ca_path: >-
      {{
        ((_oob_ca_path_input | regex_search('\\{\\{')) is not none)
        | ternary('', _oob_ca_path_input)
      }}
  changed_when: false

- name: Cache effective Redfish auth values
  ansible.builtin.set_fact:
    _oob_user_effective: "{{ oob_user }}"
    _oob_password_effective: "{{ oob_password }}"
    _oob_validate_certs_effective: "{{ oob_validate_certs }}"
    _oob_no_log_effective: "{{ oob_no_log }}"
    _oob_timeout_effective: "{{ oob_timeout }}"
    _oob_ca_path_effective: "{{ oob_ca_path }}"
  changed_when: false

- name: Normalize Redfish ID inputs
  ansible.builtin.set_fact:
    _oob_system_id_input: "{{ vars.get('oob_system_id', 'auto') | string }}"
    _oob_manager_id_input: "{{ vars.get('oob_manager_id', 'auto') | string }}"
    _oob_chassis_id_input: "{{ vars.get('oob_chassis_id', 'auto') | string }}"
  changed_when: false

- name: Guard against recursive Redfish ID templates
  ansible.builtin.set_fact:
    oob_system_id: >-
      {{
        ((_oob_system_id_input | regex_search('\\{\\{')) is not none)
        | ternary('auto', _oob_system_id_input)
      }}
    oob_manager_id: >-
      {{
        ((_oob_manager_id_input | regex_search('\\{\\{')) is not none)
        | ternary('auto', _oob_manager_id_input)
      }}
    oob_chassis_id: >-
      {{
        ((_oob_chassis_id_input | regex_search('\\{\\{')) is not none)
        | ternary('auto', _oob_chassis_id_input)
      }}
  changed_when: false

# Auto-discovery if needed
- name: Ensure Redfish IDs are known (include inventory role if needed)
  ansible.builtin.include_role:
    name: lit.foundational.oob_redfish_inventory
  vars:
    oob_baseuri: "{{ _oob_baseuri_effective }}"
    oob_user: "{{ _oob_user_effective }}"
    oob_password: "{{ _oob_password_effective }}"
    oob_validate_certs: "{{ _oob_validate_certs_effective }}"
    oob_ca_path: "{{ _oob_ca_path_effective }}"
    oob_timeout: "{{ _oob_timeout_effective }}"
    oob_no_log: "{{ _oob_no_log_effective }}"
    oob_debug: false
  when: >
    (oob_system_id is not defined) or (oob_system_id == 'auto') or
    (oob_manager_id is not defined) or (oob_manager_id == 'auto') or
    (oob_chassis_id is not defined) or (oob_chassis_id == 'auto')

- name: Require at least one action
  ansible.builtin.assert:
    that:
      - (oob_power_action | length > 0) or (oob_boot_target | length > 0) or (oob_virtual_media_action | length > 0) or (oob_boot_disable_override | bool)
    fail_msg: "Keine Aktion gesetzt. Setze oob_power_action oder oob_boot_target oder oob_virtual_media_action (oder oob_boot_disable_override=true)."

- name: Power action (optional)
  ansible.builtin.include_tasks: power.yml
  when: oob_power_action | length > 0

- name: Boot override disable (optional)
  ansible.builtin.include_tasks: boot_disable.yml
  when: oob_boot_disable_override | bool

- name: Boot override set (optional)
  ansible.builtin.include_tasks: boot.yml
  when: oob_boot_target | length > 0

- name: Virtual media (optional)
  ansible.builtin.include_tasks: virtual_media.yml
  when: oob_virtual_media_action | length > 0
